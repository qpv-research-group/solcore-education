<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.520">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>solcore-education – b-optimization</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">solcore-education</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">(Untitled)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
    <div class="sidebar-item-container"> 
        <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Examples</a>
      <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
        <i class="bi bi-chevron-right ms-2"></i>
      </a>
    </div>
    <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/1a-simple_cell.html" class="sidebar-item-text sidebar-link">Example 1a: Simple Si solar cell</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/1b-simple_cell.html" class="sidebar-item-text sidebar-link">Example 1b: Basic cell optics</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/1c-simple_cell.html" class="sidebar-item-text sidebar-link">Example 1c: Electrical models</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/2a-optical_constants.html" class="sidebar-item-text sidebar-link">Example 2a: Optical constant sources</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/2b-optical_constants.html" class="sidebar-item-text sidebar-link">Example 2b: Optical constant models</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/3a-triple_junction.html" class="sidebar-item-text sidebar-link">Example 3a: Triple junction cell</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/4a-textured_Si_cell.html" class="sidebar-item-text sidebar-link">Example 4a: Textured Si cell</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/5a-ultrathin_GaAs_cell.html" class="sidebar-item-text sidebar-link">Example 5a: Ultra-thin GaAs cell with diffraction grating</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/6a-multiscale_models.html" class="sidebar-item-text sidebar-link">Example 6a: Silicon HIT cell</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/6b-multiscale_models.html" class="sidebar-item-text sidebar-link">Example 6b: Angular redistribution matrix method</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/7a-optimization.html" class="sidebar-item-text sidebar-link">Example 7a: Simple optimization</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../solar-cell-simulation/notebooks/7b-optimization.html" class="sidebar-item-text sidebar-link active">Example 7b: More advanced optimization</a>
  </div>
</li>
    </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#example-7b-more-advanced-optimization" id="toc-example-7b-more-advanced-optimization" class="nav-link active" data-scroll-target="#example-7b-more-advanced-optimization">Example 7b: More advanced optimization</a>
  <ul class="collapse">
  <li><a href="#optical-simulation" id="toc-optical-simulation" class="nav-link" data-scroll-target="#optical-simulation">Optical simulation</a></li>
  <li><a href="#device-optimization" id="toc-device-optimization" class="nav-link" data-scroll-target="#device-optimization">Device optimization</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="example-7b-more-advanced-optimization" class="level1">
<h1>Example 7b: More advanced optimization</h1>
<p>This example looks at optimizing a four-junction Ga<span class="math inline">\(_{0.5}\)</span>In<span class="math inline">\(_{0.5}\)</span>P/GaAs/SiGeSn/Ge cell, using a <a href="https://pablormier.github.io/2017/09/05/a-tutorial-on-differential-evolution-with-python/"><em>differential evolution</em> (DE) algorithm</a>.</p>
<p>First, using a purely optical TMM simulation to calculate the photogenerated current in each sub-cell, we get an estimate of the overall thickness of each material we will need to achieve current-matching. The thing to optimize is then the current of the current-limiting cell in the structure; in other words we want to <em>maximize</em> the lowest sub-cell current, to achieve current-matching with the highest possible current. Since the differential evolution algorithm as implemented does a minimization, we are actually minimizing the negative of this value.</p>
<p>Once we have good initial values for the total layer thicknesses, we use full electrical simulation to determine the n and p type layer thicknesses to calculate a maximum possible efficiency for the 4J device.</p>
<p>To use <a href="https://github.com/pablormier/yabox">yabox</a> (used by Solcore’s the optimization module for the DE) we need to define a class which sets up the problem and has an ‘evaluate’ function, which will actually calculate the value we are trying to minimize for a set of parameters.</p>
<p><em>Note</em>: There is an issue in some versions of PyCharm with this example due to the parallel execution. To avoid this, make sure you “Run” the example as opposed to using “Run in Python Console”.</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore <span class="im">import</span> material, si</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.optics.tmm <span class="im">import</span> OptiStack</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.optics.tmm <span class="im">import</span> calculate_rat</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.optimization <span class="im">import</span> PDE, DE</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.light_source <span class="im">import</span> LightSource</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.solar_cell <span class="im">import</span> SolarCell</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.structure <span class="im">import</span> Junction, Layer</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.solar_cell_solver <span class="im">import</span> solar_cell_solver</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.constants <span class="im">import</span> q, kb</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.absorption_calculator <span class="im">import</span> search_db</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First add SiGeSn optical constants to the database:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> solcore.material_system <span class="im">import</span> create_new_material</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>create_new_material(<span class="st">'SiGeSn'</span>, <span class="st">'data/SiGeSn_n.txt'</span>, <span class="st">'data/SiGeSn_k.txt'</span>, <span class="st">'data/SiGeSn_params.txt'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: comment out these lines after the material has been added to avoid being asked</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># each time if you want to overwrite it.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>n_iters_optics <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>n_iters_device <span class="op">=</span> <span class="dv">20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="optical-simulation" class="level2">
<h2 class="anchored" data-anchor-id="optical-simulation">Optical simulation</h2>
<p>This example has a more complicated structure than the previous examples, and is based around the use of <a href="https://www.w3schools.com/python/python_classes.asp">Python <code>class</code>es</a>. For both steps of the optimization outlined above, we define a class which contains methods which generate all the information to run the simulations, and an <code>evaluate</code> method which actually returns the quantity to be optimized.</p>
<p>The methods defined in the <code>calc_min_Jsc</code> class below, which sets up the optical part of the optimization, are:</p>
<ul>
<li><code>__init__</code>: This always has to be defined for a class, as it initializes a member of the class when we call the class as <code>calc_min_Jsc()</code>. In this case, it sets up variables we need in the simulation, such as the wavelength, light source, and optical constants of the materials.</li>
<li><code>calculate</code>: This actually runs the core of the calculation by calling <code>calculate_rat</code> from Solcore to run a TMM calculation; the argument of the function is a list of the layer thicknesses. It returns the absorption in each layer of the cell, the transmission, and reflection.</li>
<li><code>evaluate</code>: This function will be used to evaluate the figure of merit for the optimization. It calls <code>calculate</code> and then calculates the maximum possible current in each sub-cell using the photon flux. It then finds the limiting (minimum) <span class="math inline">\(J_{sc}\)</span> out of the four sub-cells, and returns the negative of this value. The way the DE algorithm is implemented means it will always try to minimize what the <code>evaluate</code> function returns, so although we want to <em>maximize</em> the limiting <span class="math inline">\(J_{sc}\)</span>, we must implement this as <em>minimizing</em> its <em>negative</em>.</li>
<li><code>plot</code>: Takes the results from <code>calculate</code> and plots them to visualize our results.</li>
</ul>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> calc_min_Jsc():</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize an instance of the class; set some information which will be used in each iteration of the calculation:</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># materials, wavelengths, the light source</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        wl <span class="op">=</span> np.linspace(<span class="dv">300</span>, <span class="dv">1900</span>, <span class="dv">800</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Materials</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        SiGeSn <span class="op">=</span> material(<span class="st">'SiGeSn'</span>)()</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        GaAs <span class="op">=</span> material(<span class="st">'GaAs'</span>)()</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        InGaP <span class="op">=</span> material(<span class="st">'GaInP'</span>)(In<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        Ge <span class="op">=</span> material(<span class="st">'Ge'</span>)()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        Ta2O5_index <span class="op">=</span> search_db(<span class="st">"Ta2O5/Rodriguez"</span>)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We make these attributes of 'self' so they can be accessed by the class object</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We are also creating lists of wavelengths and corresponding n and k data from</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the Solcore materials - the reason for this is that there is currently an issue with using the Solcore</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># material class in parallel computations. Thus the information for the n and k data is saved here as a list</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># rather than a material object (see the documentation of OptiStack for the different acceptable formats</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># to pass optical constants for an OptiStack)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.wl <span class="op">=</span> wl</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.SiGeSn <span class="op">=</span> [<span class="va">self</span>.wl, SiGeSn.n(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>), SiGeSn.k(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>)]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Ge <span class="op">=</span> [<span class="va">self</span>.wl, Ge.n(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>), Ge.k(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>)]</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.InGaP <span class="op">=</span> [<span class="va">self</span>.wl, InGaP.n(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>), InGaP.k(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>)]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.GaAs <span class="op">=</span> [<span class="va">self</span>.wl, GaAs.n(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>), GaAs.k(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>)]</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MgF2 <span class="op">=</span> [<span class="va">self</span>.wl, material(<span class="st">'MgF2'</span>)().n(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>), material(<span class="st">'MgF2'</span>)().k(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>)]</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.Ta2O5 <span class="op">=</span> [<span class="va">self</span>.wl, material(<span class="bu">str</span>(Ta2O5_index),</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                                        nk_db<span class="op">=</span><span class="va">True</span>)().n(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>), material(<span class="bu">str</span>(Ta2O5_index),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                                                                                nk_db<span class="op">=</span><span class="va">True</span>)().k(<span class="va">self</span>.wl<span class="op">*</span><span class="fl">1e-9</span>)]</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assuming an AM1.5G spectrum</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spectr <span class="op">=</span> LightSource(source_type<span class="op">=</span><span class="st">'standard'</span>, version<span class="op">=</span><span class="st">'AM1.5g'</span>, x<span class="op">=</span><span class="va">self</span>.wl,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>                           output_units<span class="op">=</span><span class="st">'photon_flux_per_nm'</span>, concentration<span class="op">=</span><span class="dv">1</span>).spectrum(<span class="va">self</span>.wl)[<span class="dv">1</span>]</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate(<span class="va">self</span>, x):</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x[0] = MgF2 thickness (anti-reflection coating)</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x[1] = Ta2O5 thickness (anti-reflection coating)</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x[2] = InGaP (top junction) thickness</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x[3] = GaAs (second junction) thickness</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x[4] = SiGeSn (third junction) thickness</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keep the thickness of the bottom cell constant; from a purely optical point of view, this should be infinitely thick,</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># so there is no point in optimizing the thickness</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        SC <span class="op">=</span> [[x[<span class="dv">0</span>]] <span class="op">+</span> <span class="va">self</span>.MgF2, [x[<span class="dv">1</span>]] <span class="op">+</span> <span class="va">self</span>.Ta2O5, [x[<span class="dv">2</span>]] <span class="op">+</span> <span class="va">self</span>.InGaP, [x[<span class="dv">3</span>]] <span class="op">+</span> <span class="va">self</span>.GaAs, [x[<span class="dv">4</span>]] <span class="op">+</span> <span class="va">self</span>.SiGeSn,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>              [<span class="fl">300e3</span>] <span class="op">+</span> <span class="va">self</span>.Ge]</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create the OptiStack</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        full_stack <span class="op">=</span> OptiStack(SC, no_back_reflection<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate reflection, transmission, and absorption in each layer. We are specifying that the last layer,</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># a very thick Ge substrate, should be treated incoherently, otherwise we would see very narrow, unphysical oscillations</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in the R/A/T spectra.</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        c_list <span class="op">=</span> [<span class="st">'c'</span>]<span class="op">*</span><span class="bu">len</span>(SC)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        c_list[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="st">"i"</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        RAT <span class="op">=</span> calculate_rat(full_stack, <span class="va">self</span>.wl, no_back_reflection<span class="op">=</span><span class="va">False</span>, coherent<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>                            coherency_list<span class="op">=</span>c_list)</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extract absorption per layer</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        A_InGaP <span class="op">=</span> RAT[<span class="st">'A_per_layer'</span>][<span class="dv">3</span>]</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        A_GaAs <span class="op">=</span> RAT[<span class="st">'A_per_layer'</span>][<span class="dv">4</span>]</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        A_SiGeSn <span class="op">=</span> RAT[<span class="st">'A_per_layer'</span>][<span class="dv">5</span>]</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        A_Ge <span class="op">=</span> RAT[<span class="st">'A_per_layer'</span>][<span class="dv">6</span>]</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> A_InGaP, A_GaAs, A_SiGeSn, A_Ge, RAT[<span class="st">'T'</span>], RAT[<span class="st">'R'</span>]</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate(<span class="va">self</span>, x):</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        A_InGaP, A_GaAs, A_SiGeSn, A_Ge, _, _ <span class="op">=</span>  <span class="va">self</span>.calculate(x)</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate photo-generated currents using the AM1.5 G spectrum for each layer -- this is the current with 100%</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># internal quantum efficiency (i.e. every absorbed photon generates an electron-hole pair which is collected).</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        Jsc_InGaP <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> q <span class="op">*</span> np.trapz(A_InGaP <span class="op">*</span> <span class="va">self</span>.spectr, <span class="va">self</span>.wl)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        Jsc_GaAs <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> q <span class="op">*</span> np.trapz(A_GaAs <span class="op">*</span> <span class="va">self</span>.spectr, <span class="va">self</span>.wl)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        Jsc_SiGeSn <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> q <span class="op">*</span> np.trapz(A_SiGeSn <span class="op">*</span> <span class="va">self</span>.spectr, <span class="va">self</span>.wl)</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        Jsc_Ge <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> q <span class="op">*</span> np.trapz(A_Ge <span class="op">*</span> <span class="va">self</span>.spectr, <span class="va">self</span>.wl)</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the limiting current by checking which junction has the lowest current. Then take the negative since</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we need to minimize (not maximize)</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        limiting_Jsc <span class="op">=</span> <span class="op">-</span><span class="bu">min</span>([Jsc_InGaP, Jsc_GaAs, Jsc_SiGeSn, Jsc_Ge])</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> limiting_Jsc</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot(<span class="va">self</span>, x):</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        A_InGaP, A_GaAs, A_SiGeSn, A_Ge, T, R <span class="op">=</span> <span class="va">self</span>.calculate(x)</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        plt.figure()</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.wl, A_InGaP, label<span class="op">=</span><span class="st">'InGaP'</span>)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.wl, A_GaAs, label<span class="op">=</span><span class="st">'A_GaAs'</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.wl, A_SiGeSn, label<span class="op">=</span><span class="st">'SiGeSn'</span>)</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.wl, A_Ge, label <span class="op">=</span> <span class="st">'Ge'</span>)</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.wl, T, label<span class="op">=</span><span class="st">'T'</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        plt.plot(<span class="va">self</span>.wl, R, label<span class="op">=</span><span class="st">'R'</span>)</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Wavelength (nm)'</span>)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'R/A/T'</span>)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>        plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have defined a class containing the relevant information and methods for the optimization process, we need to make an instance of that class for the DE algorithm to use.</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>DE_class <span class="op">=</span> calc_min_Jsc()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also set the upper and lower bounds on thickness for each layer:</p>
<ul>
<li>MgF2 (ARC layer 1)</li>
<li>Ta2O5 (ARC layer 2)</li>
<li>GaInP (top junction)</li>
<li>GaAs (2nd junction)</li>
<li>SiGeSn (3rd junction)</li>
</ul>
<p>We will not optimize the thickness of the bottom Ge cell at this stage; from a purely optical point of view, this should be infinitely thick to maximize absorption, which is of course not the case for a device. We will set the thickness of the Ge at 300 <span class="math inline">\(\mu\)</span>m.</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>bounds_optics <span class="op">=</span> [[<span class="dv">10</span>,<span class="dv">150</span>], [<span class="dv">10</span>,<span class="dv">105</span>], [<span class="dv">200</span>, <span class="dv">1000</span>], [<span class="dv">500</span>, <span class="dv">10000</span>], [<span class="dv">500</span>, <span class="dv">10000</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we pass the function which will be minimized to the DE (parallel differential evolution) solver. The bounds argument sets upper and lower bounds for each parameter. <code>PDE_obj</code> contains all the information to run the DE but does not actually start the calculation (like the <code>calc_min_Jsc</code> class defined above, <code>DE</code> is a <em>class</em> and not a <em>function</em>.</p>
<p>To actually run the DE, we use the .solve() method of the DE object class:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>PDE_obj <span class="op">=</span> DE(DE_class.evaluate, bounds<span class="op">=</span>bounds_optics, maxiters<span class="op">=</span>n_iters_optics)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> PDE_obj.solve()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong><em>Note</em></strong>: <em>Due to issues with parallel computations depending on your operating system etc., we used the <code>DE</code> class here. There is also a parallelized version of this class, called <code>PDE</code>, which is already implemented above. If you are running this example on your own computer, you can run the example in parallel by simple changing <code>DE</code> to <code>PDE</code>.</em></p>
<p>PDE_obj.solve() returns a list of five items: - <code>res[0]</code> is a list of the parameters which gave the overall minimized value at the end of the process - <code>res[1]</code> is that minimized value - <code>res[2]</code> is the evolution of the best population (the best population from each iteration) - <code>res[3]</code> is the evolution of the minimized value, i.e.&nbsp;the best fitness in iteration - <code>res[4]</code> is the evolution of the mean fitness over the iterations</p>
<p>Let’s plot the absorption in each layer using the optimized thicknesses:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># best population:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>best_pop <span class="op">=</span> res[<span class="dv">0</span>]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'parameters for best result:'</span>, best_pop, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>, <span class="st">'optimized Jsc value (mA/cm2):'</span>, <span class="op">-</span>res[<span class="dv">1</span>])</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the result at these best parameters</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>DE_class.plot(best_pop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parameters for best result: [ 119.25428258   83.4922207   550.47007392 2040.13817627 1420.56539299] 
 optimized Jsc value (mA/cm2): 14.031909365709433</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="7b-optimization_files/figure-html/cell-9-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>And the evolution of the best and mean fitness with each iteration of the DE algorithm:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>best_fitn_evo <span class="op">=</span> res[<span class="dv">3</span>]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>mean_fitn_evo <span class="op">=</span> res[<span class="dv">4</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot evolution of the fitness of the best population per iteration</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="op">-</span>best_fitn_evo, <span class="st">'-k'</span>, label<span class="op">=</span><span class="st">'Best fitness'</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="op">-</span>mean_fitn_evo, <span class="st">'-r'</span>, label<span class="op">=</span><span class="st">'Mean fitness'</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Iteration'</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Fitness'</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="7b-optimization_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We see that the fitness of the best population ‘jumps’ every few iterations as a new best population is found, while the mean fitness increases slowly as the whole population gradually improves. Ideally, we would like to see the fitness converging, but it may be necessary to increase the number of iterations to achieve this.</p>
</section>
<section id="device-optimization" class="level2">
<h2 class="anchored" data-anchor-id="device-optimization">Device optimization</h2>
<p>As discussed above, we approach this optimization in two phases: a faster optical simulation to get approximate total thicknesses for each junction, and then a device optimization. We take a very similar approach and define a class to contain the information and methods needed for the device optimization:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> optimize_device():</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ARC_thickness):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ARC <span class="op">=</span> ARC_thickness</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.position <span class="op">=</span> [<span class="fl">1e-10</span>] <span class="op">*</span> <span class="dv">10</span> <span class="op">+</span> [<span class="fl">5e-8</span>] <span class="co"># 0.1 nm spacing in all layers except the Ge</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> make_cell(<span class="va">self</span>, x):</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[0]: total InGaP thickness</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[1]: total InGaAs thickness</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[2]: total SiGeSn thickness</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[3]: total Ge thickness</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[4]: InGaP n thickness</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[5]: InGaAs n thickness</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[6]: SiGeSn n thickness</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">#x[7]: Ge n thickness</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        e_charge <span class="op">=</span> si(<span class="st">'1eV'</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># materials</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        Ta2O5_index <span class="op">=</span> search_db(<span class="st">"Ta2O5/Rodriguez"</span>)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        SiGeSn <span class="op">=</span> material(<span class="st">'SiGeSn'</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        GaAs <span class="op">=</span> material(<span class="st">'GaAs'</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        InGaP <span class="op">=</span> material(<span class="st">'GaInP'</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        Ge <span class="op">=</span> material(<span class="st">'Ge'</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        MgF2 <span class="op">=</span> material(<span class="st">'MgF2'</span>)()</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        Ta2O5 <span class="op">=</span> material(<span class="bu">str</span>(Ta2O5_index), nk_db<span class="op">=</span><span class="va">True</span>)()</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        AlInP <span class="op">=</span> material(<span class="st">"AlInP"</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        window_material <span class="op">=</span> AlInP(Al<span class="op">=</span><span class="fl">0.52</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        GaInP_mobility_h <span class="op">=</span> <span class="fl">0.03</span>  <span class="co">#</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        GaInP_lifetime_h <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        GaInP_D_h <span class="op">=</span> GaInP_mobility_h <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span> <span class="op">/</span> e_charge</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        GaInP_L_h <span class="op">=</span> np.sqrt(GaInP_D_h <span class="op">*</span> GaInP_lifetime_h)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        GaInP_mobility_e <span class="op">=</span> <span class="fl">0.015</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        GaInP_lifetime_e <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        GaInP_D_e <span class="op">=</span> GaInP_mobility_e <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span> <span class="op">/</span> e_charge</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        GaInP_L_e <span class="op">=</span> np.sqrt(GaInP_D_e <span class="op">*</span> GaInP_lifetime_e)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        top_cell_n_material <span class="op">=</span> InGaP(In<span class="op">=</span><span class="fl">0.5</span>, Nd<span class="op">=</span>si(<span class="st">"2e18cm-3"</span>), hole_diffusion_length<span class="op">=</span>GaInP_L_h,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                                    hole_mobility<span class="op">=</span>GaInP_mobility_h)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        top_cell_p_material <span class="op">=</span> InGaP(In<span class="op">=</span><span class="fl">0.5</span>, Na<span class="op">=</span>si(<span class="st">"2e17cm-3"</span>), electron_diffusion_length<span class="op">=</span>GaInP_L_e,</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>                                    electron_mobility<span class="op">=</span>GaInP_mobility_e)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MID CELL  - GaAs</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        GaAs_mobility_h <span class="op">=</span> <span class="fl">0.85</span>  <span class="co">#</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>        GaAs_lifetime_h <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        GaAs_D_h <span class="op">=</span> GaAs_mobility_h <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span> <span class="op">/</span> e_charge</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>        GaAs_L_h <span class="op">=</span> np.sqrt(GaAs_D_h <span class="op">*</span> GaAs_lifetime_h)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>        GaAs_mobility_e <span class="op">=</span> <span class="fl">0.08</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>        GaAs_lifetime_e <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>        GaAs_D_e <span class="op">=</span> GaAs_mobility_e <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span> <span class="op">/</span> e_charge</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>        GaAs_L_e <span class="op">=</span> np.sqrt(GaAs_D_e <span class="op">*</span> GaAs_lifetime_e)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>        mid_cell_n_material <span class="op">=</span> GaAs(Nd<span class="op">=</span>si(<span class="st">"1e18cm-3"</span>), hole_diffusion_length<span class="op">=</span>GaAs_L_h,</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>                                   hole_mobility<span class="op">=</span>GaAs_mobility_h)</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>        mid_cell_p_material <span class="op">=</span> GaAs(Na<span class="op">=</span>si(<span class="st">"1e17cm-3"</span>), electron_diffusion_length<span class="op">=</span>GaAs_L_e,</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>                                   electron_mobility<span class="op">=</span>GaAs_mobility_e)</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>        SiGeSn.band_gap <span class="op">=</span> si(<span class="st">'0.77eV'</span>) <span class="co"># from PL measurement</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>        SiGeSn_L_h <span class="op">=</span> si(<span class="st">'0.35um'</span>)</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>        SiGeSn_L_e <span class="op">=</span> si(<span class="st">'5um'</span>)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>        SiGeSn_lifetime_e <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>        SiGeSn_lifetime_h <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>        SiGeSn_mobility_h <span class="op">=</span> SiGeSn_L_h <span class="op">**</span> <span class="dv">2</span> <span class="op">*</span> e_charge <span class="op">/</span> (SiGeSn_lifetime_h <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span>)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        SiGeSn_mobility_e <span class="op">=</span> SiGeSn_L_e <span class="op">**</span> <span class="dv">2</span> <span class="op">*</span> e_charge <span class="op">/</span> (SiGeSn_lifetime_e <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span>)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        pen_cell_n_material <span class="op">=</span> SiGeSn(Nd<span class="op">=</span>si(<span class="st">"1e18cm-3"</span>), hole_diffusion_length<span class="op">=</span>SiGeSn_L_h,</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>                                     relative_permittivity<span class="op">=</span><span class="dv">16</span>, hole_mobility<span class="op">=</span>SiGeSn_mobility_h)</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>        pen_cell_p_material <span class="op">=</span> SiGeSn(Na<span class="op">=</span>si(<span class="st">"1e17cm-3"</span>), electron_diffusion_length<span class="op">=</span>SiGeSn_L_e,</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>                                     relative_permittivity<span class="op">=</span><span class="dv">16</span>, electron_mobility<span class="op">=</span>SiGeSn_mobility_e)</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>        Ge_lifetime_h <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>        Ge_L_h <span class="op">=</span> si(<span class="st">'500nm'</span>)</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>        Ge_mobility_h <span class="op">=</span> Ge_L_h <span class="op">**</span> <span class="dv">2</span> <span class="op">*</span> e_charge <span class="op">/</span> (Ge_lifetime_h <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span>)</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>        Ge_mobility_e <span class="op">=</span> <span class="fl">0.18</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>        Ge_lifetime_e <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>        Ge_D_e <span class="op">=</span> Ge_mobility_e <span class="op">*</span> kb <span class="op">*</span> <span class="dv">300</span> <span class="op">/</span> e_charge</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>        Ge_L_e <span class="op">=</span> np.sqrt(Ge_D_e <span class="op">*</span> Ge_lifetime_e)</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>        bot_cell_n_material <span class="op">=</span> Ge(Nd<span class="op">=</span>si(<span class="st">"2e18cm-3"</span>), hole_diffusion_length<span class="op">=</span>Ge_L_h,</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>                                 hole_mobility<span class="op">=</span>Ge_mobility_h)</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>        bot_cell_p_material <span class="op">=</span> Ge(Na<span class="op">=</span>si(<span class="st">"1e17cm-3"</span>), electron_diffusion_length<span class="op">=</span>Ge_L_e,</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>                                 electron_mobility<span class="op">=</span>Ge_mobility_e)</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>        solar_cell <span class="op">=</span> SolarCell([</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>            Layer(si(<span class="va">self</span>.ARC[<span class="dv">0</span>], <span class="st">'nm'</span>), material<span class="op">=</span>MgF2), Layer(si(<span class="va">self</span>.ARC[<span class="dv">1</span>], <span class="st">'nm'</span>), material<span class="op">=</span>Ta2O5),</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>            Junction([Layer(si(<span class="dv">25</span>, <span class="st">'nm'</span>), material<span class="op">=</span>window_material, role<span class="op">=</span><span class="st">'window'</span>),</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>                      Layer(si(x[<span class="dv">4</span>], <span class="st">'nm'</span>), material<span class="op">=</span>top_cell_n_material, role<span class="op">=</span><span class="st">'emitter'</span>),</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>                      Layer(si(x[<span class="dv">0</span>]<span class="op">-</span>x[<span class="dv">4</span>], <span class="st">'nm'</span>), material<span class="op">=</span>top_cell_p_material, role<span class="op">=</span><span class="st">'base'</span>),</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>                      ], sn<span class="op">=</span><span class="dv">1</span>, sp<span class="op">=</span><span class="dv">1</span>, kind<span class="op">=</span><span class="st">'DA'</span>),</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>            Junction([Layer(si(x[<span class="dv">5</span>], <span class="st">'nm'</span>), material<span class="op">=</span>mid_cell_n_material, role<span class="op">=</span><span class="st">'emitter'</span>),</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>                      Layer(si(x[<span class="dv">1</span>]<span class="op">-</span>x[<span class="dv">5</span>], <span class="st">'nm'</span>), material<span class="op">=</span>mid_cell_p_material, role<span class="op">=</span><span class="st">'base'</span>),</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>                      ], sn<span class="op">=</span><span class="dv">1</span>, sp<span class="op">=</span><span class="dv">1</span>, kind<span class="op">=</span><span class="st">'DA'</span>),</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>            Junction([Layer(si(x[<span class="dv">6</span>], <span class="st">'nm'</span>), material<span class="op">=</span>pen_cell_n_material, role<span class="op">=</span><span class="st">'emitter'</span>),</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>                      Layer(si(x[<span class="dv">2</span>]<span class="op">-</span>x[<span class="dv">6</span>], <span class="st">'nm'</span>), material<span class="op">=</span>pen_cell_p_material, role<span class="op">=</span><span class="st">'base'</span>),</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>                      ], sn<span class="op">=</span><span class="dv">1</span>, sp<span class="op">=</span><span class="dv">1</span>, kind<span class="op">=</span><span class="st">'DA'</span>),</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>            Junction([Layer(si(x[<span class="dv">7</span>], <span class="st">'nm'</span>), material<span class="op">=</span>bot_cell_n_material, role<span class="op">=</span><span class="st">'emitter'</span>),</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>                      Layer(si(x[<span class="dv">3</span>]<span class="op">-</span>x[<span class="dv">7</span>], <span class="st">'nm'</span>), material<span class="op">=</span>bot_cell_p_material, role<span class="op">=</span><span class="st">'base'</span>),</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>                      ], sn<span class="op">=</span><span class="dv">1</span>, sp<span class="op">=</span><span class="dv">1</span>, kind<span class="op">=</span><span class="st">'DA'</span>),</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>        ], shading<span class="op">=</span><span class="fl">0.0</span>, substrate<span class="op">=</span>bot_cell_n_material)</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> solar_cell</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate(<span class="va">self</span>, x):</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>        light_source <span class="op">=</span> LightSource(source_type<span class="op">=</span><span class="st">'standard'</span>, version<span class="op">=</span><span class="st">'AM1.5g'</span>)</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>        wl <span class="op">=</span> np.linspace(<span class="dv">300</span>, <span class="dv">1850</span>, <span class="dv">500</span>) <span class="op">*</span> <span class="fl">1e-9</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>        solar_cell <span class="op">=</span> <span class="va">self</span>.make_cell(x)</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="fl">3.5</span>, <span class="dv">300</span>)</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>        solar_cell_solver(solar_cell, <span class="st">'iv'</span>,</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>                          user_options<span class="op">=</span>{<span class="st">'voltages'</span>: V, <span class="st">'light_iv'</span>: <span class="va">True</span>, <span class="st">'wavelength'</span>: wl, <span class="st">'mpp'</span>: <span class="va">True</span>,</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">'light_source'</span>: light_source,</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">'optics_method'</span>: <span class="st">'TMM'</span>, <span class="st">'BL_correction'</span>: <span class="va">True</span>,</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">'position'</span>: <span class="va">self</span>.position})</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> wl, solar_cell</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate(<span class="va">self</span>, x):</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>        _, solar_cell <span class="op">=</span> <span class="va">self</span>.calculate(x)</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>        efficiency <span class="op">=</span> solar_cell.iv[<span class="st">"Eta"</span>]</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>efficiency</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot(<span class="va">self</span>, x):</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>        wl, solar_cell <span class="op">=</span> <span class="va">self</span>.calculate(x)</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> solar_cell.iv[<span class="st">'IV'</span>][<span class="dv">0</span>]</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>        efficiency <span class="op">=</span> solar_cell.iv[<span class="st">"Eta"</span>]</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>        pmax <span class="op">=</span> solar_cell.iv[<span class="st">"Pmpp"</span>]</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>        ff <span class="op">=</span> solar_cell.iv[<span class="st">"FF"</span>]</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>        voc <span class="op">=</span> solar_cell.iv[<span class="st">"Voc"</span>]</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>        isc <span class="op">=</span> solar_cell.iv[<span class="st">"Isc"</span>]</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>        plt.figure()</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>        plt.plot(V, solar_cell.iv[<span class="st">'IV'</span>][<span class="dv">1</span>] <span class="op">/</span> <span class="dv">10</span>, <span class="st">'k'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'Total'</span>)</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>        plt.plot(V, <span class="op">-</span>solar_cell[<span class="dv">2</span>].iv(V) <span class="op">/</span> <span class="dv">10</span>, <span class="st">'b'</span>, label<span class="op">=</span><span class="st">'GaInP'</span>)</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>        plt.plot(V, <span class="op">-</span>solar_cell[<span class="dv">3</span>].iv(V) <span class="op">/</span> <span class="dv">10</span>, <span class="st">'g'</span>, label<span class="op">=</span><span class="st">'GaAs'</span>)</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>        plt.plot(V, <span class="op">-</span>solar_cell[<span class="dv">4</span>].iv(V) <span class="op">/</span> <span class="dv">10</span>, <span class="st">'r'</span>, label<span class="op">=</span><span class="st">'SiGeSn'</span>)</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>        plt.plot(V, <span class="op">-</span>solar_cell[<span class="dv">5</span>].iv(V) <span class="op">/</span> <span class="dv">10</span>, <span class="st">'y'</span>, label<span class="op">=</span><span class="st">'Ge'</span>)</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>        plt.text(<span class="dv">2</span>, <span class="dv">10</span>, <span class="st">'$\eta = $'</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(efficiency <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>)) <span class="op">+</span> <span class="st">'%'</span>)</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>        plt.text(<span class="dv">2</span>, <span class="dv">8</span>,<span class="st">'Pmax='</span><span class="op">+</span><span class="bu">str</span>(<span class="bu">round</span>(pmax,<span class="dv">1</span>))<span class="op">+</span><span class="st">'W/m$^2$'</span>)</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>        plt.text(<span class="dv">2</span>, <span class="dv">9</span>, <span class="st">'FF = '</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">round</span>(ff <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>)) <span class="op">+</span> <span class="st">'%'</span>)</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>        plt.text(<span class="dv">2</span>,<span class="dv">7</span>,<span class="st">'Voc='</span><span class="op">+</span><span class="bu">str</span>(<span class="bu">round</span>(voc,<span class="dv">1</span>))<span class="op">+</span><span class="st">'V'</span>)</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>        plt.text(<span class="dv">2</span>,<span class="dv">6</span>, <span class="st">'Jsc='</span><span class="op">+</span><span class="bu">str</span>(<span class="bu">round</span>(<span class="fl">0.1</span><span class="op">*</span>isc,<span class="dv">1</span>))<span class="op">+</span><span class="st">'mA/cm$^2$'</span>)</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>        plt.ylim(<span class="dv">0</span>, <span class="dv">18</span>)</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>        plt.xlim(<span class="dv">0</span>, <span class="fl">3.5</span>)</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Current (mA/cm$^2$)'</span>)</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Voltage (V)'</span>)</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>        solar_cell_solver(solar_cell, <span class="st">'qe'</span>,</span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>                         user_options<span class="op">=</span>{<span class="st">'wavelength'</span>: wl, <span class="st">'optics_method'</span>: <span class="st">'TMM'</span>, <span class="st">'BL_correction'</span>: <span class="va">True</span>, <span class="st">'position'</span>: <span class="va">self</span>.position})</span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>        plt.figure()</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>        plt.plot(wl <span class="op">*</span> <span class="fl">1e9</span>, solar_cell[<span class="dv">2</span>].eqe(wl) <span class="op">*</span> <span class="dv">100</span>, <span class="st">'b'</span>, label<span class="op">=</span><span class="st">'InGaP'</span>)</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>        plt.plot(wl <span class="op">*</span> <span class="fl">1e9</span>, solar_cell[<span class="dv">3</span>].eqe(wl) <span class="op">*</span> <span class="dv">100</span>, <span class="st">'g'</span>, label<span class="op">=</span><span class="st">'InGaAs'</span>)</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>        plt.plot(wl <span class="op">*</span> <span class="fl">1e9</span>, solar_cell[<span class="dv">4</span>].eqe(wl) <span class="op">*</span> <span class="dv">100</span>, <span class="st">'r'</span>, label<span class="op">=</span><span class="st">'SiGeSn'</span>)</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>        plt.plot(wl <span class="op">*</span> <span class="fl">1e9</span>, solar_cell[<span class="dv">5</span>].eqe(wl) <span class="op">*</span> <span class="dv">100</span>, <span class="st">'y'</span>, label<span class="op">=</span><span class="st">'Ge'</span>)</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>        plt.plot(wl <span class="op">*</span> <span class="fl">1e9</span>, solar_cell.absorbed <span class="op">*</span> <span class="dv">100</span>, <span class="st">'k--'</span>, label<span class="op">=</span><span class="st">'Absorption'</span>)</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.plot(wl * 1e9, solar_cell[5].eqe(wl)*100, 'y', label='Ge')</span></span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>        plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>        plt.xlim(<span class="dv">290</span>, <span class="dv">1850</span>)</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>        plt.ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'EQE (%)'</span>)</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Wavelength (nm)'</span>)</span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>        plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that the layer thicknesses have been optimized from an optical point of view, we want to design the device (or at least a simplified version, by calculating a more realistic EQE. Obviously additional parameters like the doping of the layers could be varied too. The list of parameters <code>x</code> will be:</p>
<ul>
<li><p>x[0]: total InGaP thickness</p></li>
<li><p>x[1]: total InGaAs thickness</p></li>
<li><p>x[2]: total SiGeSn thickness</p></li>
<li><p>x[3]: total Ge thickness</p></li>
<li><p>x[4]: InGaP emitter thickness</p></li>
<li><p>x[5]: InGaAs emitter thickness</p></li>
<li><p>x[6]: SiGeSn emitter thickness</p></li>
<li><p>x[7]: Ge emitter thickness</p></li>
</ul>
<p>We will keep the ARC thicknesses fixed at the exact values obtained in the optical simulation. For the other layers, we generate upper and lower bounds: total layer thickness between 75% and 125% of values fitted in TMM calculation. For Ge, we set the starting value at 200 <span class="math inline">\(\mu\)</span>m.</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>starting_params <span class="op">=</span> np.append(best_pop[<span class="dv">2</span>:], [<span class="dv">200000</span>])</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>lower <span class="op">=</span> <span class="fl">0.75</span><span class="op">*</span>starting_params</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>upper <span class="op">=</span> <span class="fl">1.25</span><span class="op">*</span>starting_params</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># upper and lower bounds for the n-type (highly doped) layers</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>lower_ntype <span class="op">=</span> [<span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">20</span>, <span class="dv">20</span>]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>upper_ntype <span class="op">=</span> [<span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">300</span>, <span class="dv">500</span>]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>all_lower <span class="op">=</span> np.append(lower, lower_ntype)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>all_upper <span class="op">=</span> np.append(upper, upper_ntype)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># full list of bounds</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>all_bounds <span class="op">=</span> np.stack((all_lower, all_upper)).T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similar to the optical simulation above, we now create an object of this class (setting the ARC thickness when we create the class), then create an object of the <code>DE</code> class, and call the <code>.solve</code> method.</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DE calculation for the electrical simulation</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>DE_class_DA <span class="op">=</span> optimize_device(best_pop[<span class="dv">0</span>:<span class="dv">2</span>])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># default population size = 5*number of params</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>PDE_obj_DA <span class="op">=</span> DE(DE_class_DA.evaluate, bounds<span class="op">=</span>all_bounds, maxiters<span class="op">=</span>n_iters_device)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># solve, i.e. minimize the problem</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>res_DA <span class="op">=</span> PDE_obj_DA.solve()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot the QE and IV for the best population:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>best_pop_DA <span class="op">=</span> res_DA[<span class="dv">0</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'parameters for best result:'</span>, best_pop_DA, <span class="st">'optimized efficiency (%)'</span>, res_DA[<span class="dv">1</span>]<span class="op">*</span><span class="dv">100</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the result at these best parameters</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>DE_class_DA.plot(best_pop_DA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parameters for best result: [5.64211912e+02 1.67613064e+03 1.08983977e+03 1.99726177e+05
 1.71208031e+02 1.18811297e+02 4.59410919e+01 1.07605130e+02] optimized efficiency (%) -35.688813260065366
Database file found at /Users/phoebe/.solcore/nk/nk.db
1 results found.
pageid  shelf   book    page    filepath    hasrefractive   hasextinction   rangeMin    rangeMax    points
475 main    Ta2O5   Rodriguez-de_Marcos main/Ta2O5/Rodriguez-de Marcos.yml  1   1   0.0294938   1.51429 212
Solving optics of the solar cell...
Treating layer(s) 10 incoherently
Calculating RAT...
Database file found at /Users/phoebe/.solcore/nk/nk.db
Material main/Ta2O5/Rodriguez-de Marcos.yml loaded.
Database file found at /Users/phoebe/.solcore/nk/nk.db
Material main/Ta2O5/Rodriguez-de Marcos.yml loaded.
Calculating absorption profile...
Solving IV of the junctions...
Solving IV of the tunnel junctions...
Solving IV of the total solar cell...</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="7b-optimization_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Solving optics of the solar cell...
Already calculated reflection, transmission and absorption profile - not recalculating. Set recalculate_absorption to True in the options if you want absorption to be calculated again.
Solving QE of the solar cell...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/phoebe/Documents/develop/solcore5/solcore/analytic_solar_cells/depletion_approximation.py:617: RuntimeWarning: invalid value encountered in true_divide
  iqe =  j_sc / current_absorbed</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="7b-optimization_files/figure-html/cell-14-output-5.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>best_pop_evo <span class="op">=</span> res_DA[<span class="dv">2</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>best_fitn_evo <span class="op">=</span> res_DA[<span class="dv">3</span>]</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>mean_fitn_evo <span class="op">=</span> res_DA[<span class="dv">4</span>]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>final_fitness <span class="op">=</span> res_DA[<span class="dv">1</span>]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot evolution of the fitness of the best population per iteration</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="op">-</span>best_fitn_evo, <span class="st">'-k'</span>, label<span class="op">=</span><span class="st">'Best fitness'</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="op">-</span>mean_fitn_evo, <span class="st">'-r'</span>, label<span class="op">=</span><span class="st">'Mean fitness'</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Iteration'</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Fitness'</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="7b-optimization_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="comparison" class="level2">
<h2 class="anchored" data-anchor-id="comparison">Comparison</h2>
<p>Compare the total layer thicknesses obtained from the optical and electrical simulations:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Comparison of thicknesses from optical/electrical optimization:"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'GaInP total thickness: </span><span class="sc">%.1f</span><span class="st">/</span><span class="sc">%.1f</span><span class="st"> nm'</span> <span class="op">%</span> (best_pop[<span class="dv">2</span>], best_pop_DA[<span class="dv">0</span>]))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'GaAs total thickness: </span><span class="sc">%.1f</span><span class="st">/</span><span class="sc">%.1f</span><span class="st"> nm'</span> <span class="op">%</span> (best_pop[<span class="dv">3</span>], best_pop_DA[<span class="dv">1</span>]))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'SiGeSn total thickness: </span><span class="sc">%.1f</span><span class="st">/</span><span class="sc">%.1f</span><span class="st"> nm'</span> <span class="op">%</span> (best_pop[<span class="dv">4</span>], best_pop_DA[<span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Comparison of thicknesses from optical/electrical optimization:
GaInP total thickness: 550.5/564.2 nm
GaAs total thickness: 2040.1/1676.1 nm
SiGeSn total thickness: 1420.6/1089.8 nm</code></pre>
</div>
</div>
<p><strong>NOTE</strong>: You may have an issue running the parallel version of this example (change <code>DE</code> to <code>PDE</code>) if you are using Windows. To get around this, you need to use the <a href="https://stackoverflow.com/questions/419163/what-does-if-name-main-do"><code>if __name__ == "__main__"</code></a> construction. The issue arises because the multiprocessing module uses a different process on Windows than on UNIX systems which will throw errors if this construction is not used. You need to put everything apart from the module imports at the top of the script and the class definitions inside a function called <code>main</code>, and execute this with:</p>
<div class="cell" data-pycharm="{&quot;name&quot;:&quot;#%%\n&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if __name__ == '__main__':</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     main()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>